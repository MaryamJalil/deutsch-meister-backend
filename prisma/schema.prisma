datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String
  role         Role     @default(STUDENT)
  refreshToken String?
  createdAt    DateTime @default(now())
}

enum Role {
  ADMIN
  STUDENT
  TEACHER
}

model Course {
  id        Int       @id @default(autoincrement())
  title     String
  language  String
  levels    Level[]
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([deletedAt])
}

model Level {
  id        Int       @id @default(autoincrement())
  code      LevelName
  position  Int
  courseId  Int
  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  modules   Module[]
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")
  lessons   Lesson[]

  @@unique([courseId, code, deletedAt])
  @@index([courseId])
  @@index([courseId, position])
}

enum LevelName {
  A1
  A2
  B1
  B2
  C1
  C2
}

model Module {
  id        Int       @id @default(autoincrement())
  title     String
  order     Int
  levelId   Int
  level     Level     @relation(fields: [levelId], references: [id])
  lessons   Lesson[]
  deletedAt DateTime?

  @@index([levelId])
}

model Lesson {
  id Int @id @default(autoincrement())

  title       String
  description String?
  content     String // Markdown lesson content

  order Int // Order inside a level

  levelId Int
  level   Level @relation(fields: [levelId], references: [id])

  vocabulary Vocabulary[]
  examples   Example[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  module    Module?  @relation(fields: [moduleId], references: [id])
  moduleId  Int?

  @@unique([levelId, order]) // No duplicate order in same level
  @@index([levelId]) // Fast lookup by level
}

model Vocabulary {
  id Int @id @default(autoincrement())

  word    String
  meaning String

  lessonId Int
  lesson   Lesson @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())

  @@unique([lessonId, word]) // No duplicate words per lesson
  @@index([lessonId])
}

model Example {
  id Int @id @default(autoincrement())

  sentence    String
  translation String

  lessonId Int
  lesson   Lesson @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())

  @@index([lessonId])
}
